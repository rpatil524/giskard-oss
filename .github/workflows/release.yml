name: Release
on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Library to release'
        required: true
        type: choice
        options:
          - giskard-core
          - giskard-agents
          - giskard-checks
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
          - none
        default: patch
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - alpha
          - beta
          - rc
          - none
        default: none
      dry_run:
        description: 'If true, the release will not be published to PyPI'
        required: false
        type: boolean
        default: true

concurrency:
  group: release-${{ github.event.inputs.package }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PACKAGE: ${{ github.event.inputs.package }}
      BUMP_TYPE: ${{ github.event.inputs.bump_type }}
      RELEASE_TYPE: ${{ github.event.inputs.release_type }}
    steps:
      - name: Authorize
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTOR: ${{ github.actor }}
        run: |
          if ! gh api "orgs/Giskard-AI/members/$ACTOR" --silent 2>/dev/null; then
            echo "::error::Only Giskard-AI organization members can create releases."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.RELEASE_PAT_TOKEN }} # Needed to trigger other actions

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7
        with:
          python-version: "3.12"

      - name: Setup development environment
        run: make setup

      - name: Run checks
        run: make check

      - name: Run tests
        env:
          TEST_MODEL: "gemini/gemini-2.0-flash"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: make test

      - name: Bump version
        id: bump
        working-directory: libs/${{ env.PACKAGE }}
        run: |
          CMD=("uv" "version")

          if [ "$BUMP_TYPE" != "none" ]; then
            CMD+=("--bump" "$BUMP_TYPE")
          fi

          if [ "$RELEASE_TYPE" != "none" ] && [ -n "$RELEASE_TYPE" ]; then
            CMD+=("--bump" "$RELEASE_TYPE")
          fi

          if [ ${#CMD[@]} -gt 2 ]; then
            "${CMD[@]}"
          else
            echo "No version bump"
            exit 1
          fi

          NEW_VERSION=$(uv version --short)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$PACKAGE/v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Build package
        working-directory: libs/${{ env.PACKAGE }}
        run: |
          uv build --out-dir dist

      - name: Commit version bump
        working-directory: libs/${{ env.PACKAGE }}
        env:
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "pyproject.toml"
          git commit -m "chore($PACKAGE): bump version to $NEW_VERSION"

      - name: Push to main
        if: ${{ github.event.inputs.dry_run == false && github.ref_name == 'main' }}
        run: |
          git push origin main

      - name: Create tag
        if: ${{ github.event.inputs.dry_run == false }}
        env:
          TAG: ${{ steps.bump.outputs.tag }}
        run: |
          git tag "$TAG"
          git push origin "$TAG"


      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry_run == false }}
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ steps.bump.outputs.tag }}
          name: "${{ env.PACKAGE }} v${{ steps.bump.outputs.new_version }}"
          generate_release_notes: true
          files: |
            libs/${{ env.PACKAGE }}/dist/*.tar.gz
            libs/${{ env.PACKAGE }}/dist/*.whl
            
      - name: Push to PyPI
        if: ${{ github.event.inputs.dry_run == false }}
        working-directory: libs/${{ env.PACKAGE }}
        env:
          PIPY_USERNAME: ${{ secrets.PIPY_USERNAME }}
          PIPY_PASSWORD: ${{ secrets.PIPY_PASSWORD }}
        run: uv publish --username "$PIPY_USERNAME" --password "$PIPY_PASSWORD"
